<!DOCTYPE html>
<html class="no-js" lang="en-US" prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#">
<head>
    <meta charset="utf-8">

    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="description" content="">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">

<meta name="description" content="The New MongoDB Bulk API">
<meta name="keywords" content="Development, MongoDB, Node.js, github, mongodb, js, Javascript, ">

 
<meta property="og:type" content="article"/>
<meta property="og:description" content="The New MongoDB Bulk API"/>
<meta property="og:title" content="The New Bulk API : christiankvalheim.com"/>
<meta property="og:site_name" content="Christian Kvalheim"/>
<meta property="og:image" content="" />
<meta property="og:image:type" content="image/jpeg" />
<meta property="og:image:width" content="" />
<meta property="og:image:height" content="" />
<meta property="og:url" content="http://localhost:1313/post/the_new_bulk_api">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2014-04-16"/>
<meta property="article:modified_time" content="2014-04-16"/>

<meta property="article:tag" content="Development">
<meta property="article:tag" content="MongoDB">
<meta property="article:tag" content="Node.js">
<meta property="article:tag" content="github">
<meta property="article:tag" content="mongodb">
<meta property="article:tag" content="js">
<meta property="article:tag" content="Javascript">



<meta name="twitter:card" content="summary">

<meta name="twitter:site" content="@christkv">
<meta name="twitter:title" content="The New Bulk API : christiankvalheim.com">
<meta name="twitter:creator" content="@christkv">
<meta name="twitter:description" content="The New MongoDB Bulk API">
<meta name="twitter:image:src" content="">
<meta name="twitter:domain" content="christiankvalheim.com">



    <base href="http://localhost:1313">
    <title> The New Bulk API - christiankvalheim.com </title>
    <link rel="canonical" href="http://localhost:1313/post/the_new_bulk_api">
    

    <link href='http://fonts.googleapis.com/css?family=Fjalla+One|Open+Sans:300' rel='stylesheet' type='text/css'>
<link rel="stylesheet" href="http://localhost:1313/static/css/style.css">
<link rel="stylesheet" href="http://yandex.st/highlightjs/8.0/styles/default.min.css">
<script src="http://yandex.st/highlightjs/8.0/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

    <link rel="shortcut icon" href="http://localhost:1313/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png" />
		<link rel="stylesheet" href="http://yandex.st/highlightjs/8.0/styles/default.min.css">
		<script src="http://yandex.st/highlightjs/8.0/highlight.min.js"></script>
</head>

<body lang="en" itemscope itemtype="http://schema.org/Article">
<header id="header">
<figure>
      <a href="http://localhost:1313/" border=0 id="logolink"><img src="./logo.png"></img></a>
      </figure>
    <div id="byline">by Christian Kvalheim</div>
    <nav id="nav">
            <ul id="mainnav">
            <li>
                <a href="http://localhost:1313/post/">
                <span class="icon"> <i aria-hidden="true" class="icon-quill"></i></span>
                <span> blog </span>
            </a>
            </li>
            <li>
            <a href="http://localhost:1313/project/">
                <span class="icon"> <i aria-hidden="true" class="icon-console"></i></span>
                <span> code </span>
            </a>
            </li>
            <li>
            <a href="http://localhost:1313/presentation/">
                <span class="icon"> <i aria-hidden="true" class="icon-stats"></i></span>
                <span> talks </span>
            </a>
            </li>
        </ul>

            <ul id="social">
            <li id="share">
                <span class="icon icon-bubbles"> </span>
                <span class="title"> share </span>
                <div class="dropdown share">
                    <ul class="social">
                      <li> <a href="https://twitter.com/intent/tweet?status=The%20New%20Bulk%20API-http%3a%2f%2flocalhost%3a1313%2fpost%2fthe_new_bulk_api" target="_blank" title="Follow me on Twitter" class="twitter"><span class="icon icon-twitter"></span>Twitter</a> </li>
                        <li> <a href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2flocalhost%3a1313%2fpost%2fthe_new_bulk_api" target="_blank" title="Join me on Facebook" class="facebook"><span class="icon icon-facebook"></span>Facebook</a> </li>
                        <li> <a href="https://plus.google.com/share?url=http%3a%2f%2flocalhost%3a1313%2fpost%2fthe_new_bulk_api" target="_blank" title="Google+" class="googleplus"><span class="icon icon-google-plus"></span>Google+</a> </li>
                        <li> <a href="http://www.linkedin.com/shareArticle?mini=true&url=http%3a%2f%2flocalhost%3a1313%2fpost%2fthe_new_bulk_api&title=The%20New%20Bulk%20API&source=spf13" target="_blank" title="LinkedIn" class="linkedin"><span class="icon icon-linkedin"></span>LinkedIn</a> </li>
                        <li> <a href="http://del.icio.us/post?url=http%3a%2f%2flocalhost%3a1313%2fpost%2fthe_new_bulk_api" target="_blank" title="Delicious" class="delicious"><span class="icon icon-delicious"></span>Delicious</a> </li>
                        <li> <a href="http://www.reddit.com/submit?url=http%3a%2f%2flocalhost%3a1313%2fpost%2fthe_new_bulk_api" target="_blank" title="Reddit" class="reddit"><span class="icon icon-reddit"></span>Reddit</a> </li>
                        <li> <a href="http://www.stumbleupon.com/submit?url=http%3a%2f%2flocalhost%3a1313%2fpost%2fthe_new_bulk_api" target="_blank" title="StumbleUpon" class="stumbleupon"><span class="icon icon-stumbleupon"></span>StumbleUpon</a> </li>
                    </ul>
                    <span class="subcount">sharing is caring</span>
                </div>
            </li>
            <li id="follow">
                <span class="icon icon-rocket"> </span>
                <span class="title"> follow </span>
                <div class="dropdown follow">
                    <ul class="social">
                        <li> <a href="http://christiankvalheim.com/index.xml" target="_blank" title="Subscribe by RSS" class="rss"><span class="icon icon-feed-2"></span>RSS</a> </li>
                        <li> <a href="http://www.twitter.com/christkv" target="_blank" title="Follow me on Twitter" class="twitter"><span class="icon icon-twitter"></span>Twitter</a> </li>
                        <li> <a href="http://www.linkedin.com/in/christkv" target="_blank" title="LinkedIn" class="linkedin"><span class="icon icon-linkedin"></span>LinkedIn</a> </li>
                        <li> <a href="http://github.com/christkv" target="_blank" title="GitHub" class="github"><span class="icon icon-github"></span>GitHub</a> </li>
                        <li> <a href="http://www.slideshare.net/christkv" target="_blank" title="SlideShare" class="slideshare"><span class="icon icon-slideshare"></span>SlideShare</a> </li>
                    </ul>
                    <span class="subcount">join 730+ followers and subscribers</span>
                </div>
            </li>
        </ul>

    </nav>
</header>



<section id="main">
  <h1 itemprop="name" id="title">The New Bulk API</h1>
  <div>
        <article itemprop="articleBody" id="content">
           

<h1 id="toc_0">The New Bulk API</h1>

<p>One of the core new features in MongoDB 2.6 is the new bulk write operations. All the drivers include a new bulk api that allows applications to leverage these new operations using a fluid style API. Let&rsquo;s explore the API and how it&rsquo;s implemented in the Node.js driver.</p>

<h2 id="toc_1">The API</h2>

<p>The API have two core concepts. The <strong>ordered</strong> and the <strong>unordered</strong> bulk operation. The main difference is in the way the operations in a bulk are executed. In the case of an <strong>ordered</strong> bulk operation every operation will be executed in the order they are added to the bulk operation. In the case of an <strong>unordered</strong> bulk operation however there is no guarantee what order the operations are executed. Later we will look at how they both are implemented.</p>

<h2 id="toc_2">Operations</h2>

<p>You can initialize an <strong>ordered</strong> or <strong>unordered</strong> bulk operation in the following way.</p>

<pre><code>var ordered = db.collection('documents').initializeOrderedBulkOp();
var unordered = db.collection('documents').initializeUnorderedBulkOp();
</code></pre>

<p>Once you have a bulk operation you can start adding operations to the bulk. The following operations are valid.</p>

<h3 id="toc_3">updateOne (update first matching document)</h3>

<pre><code>ordered.find({ a : 1 }).updateOne({$inc : {x : 1}});
</code></pre>

<h3 id="toc_4">update (update all matching documents)</h3>

<pre><code>ordered.find({ a : 1 }).update({$inc : {x : 2}});
</code></pre>

<h3 id="toc_5">replaceOne (replace entire document)</h3>

<pre><code>ordered.find({ a : 1 }).replaceOne({ x : 2});
</code></pre>

<h3 id="toc_6">updateOne or upsert (update first existing document or upsert)</h3>

<pre><code>ordered.find({ a : 2 }).upsert().updateOne({ $inc : { x : 1}});
</code></pre>

<h3 id="toc_7">update or upsert (update all or upsert)</h3>

<pre><code>ordered.find({ a : 2 }).upsert().update({ $inc : { x : 2}});
</code></pre>

<h3 id="toc_8">replace or upsert (replace first document or upsert)</h3>

<pre><code>ordered.find({ a : 2 }).upsert().replaceOne({ x : 3 });
</code></pre>

<h3 id="toc_9">removeOne (remove the first document matching)</h3>

<pre><code>ordered.find({ a : 2 }).removeOne();
</code></pre>

<h3 id="toc_10">remove (remove all documents matching)</h3>

<pre><code>ordered.find({ a : 1 }).remove();
</code></pre>

<h3 id="toc_11">insert</h3>

<pre><code>ordered.insert({ a : 5});
</code></pre>

<p>So what happens under the covers when you do start adding operations to a bulk operation. Let&rsquo;s take a look at the new write operations.</p>

<h2 id="toc_12">The New Write Operations</h2>

<p>MongoDB 2.6 introduces a completely new set of write operations. Before 2.6 all write operations where done using wire protocol messages at the socket level. From 2.6 this changes to using commands. So what does these commands look like.</p>

<h3 id="toc_13">Insert Write Command</h3>

<p>The insert write commands allow an application insert batches of documents. Let&rsquo;s take a look at the command and it&rsquo;s options.</p>

<pre><code>{
    insert: 'collection name'
  , documents: [{ a : 1}, ...]
  , writeConcern: {
    w: 1, j: true, wtimeout: 1000
  }
  , ordered: true/false
}
</code></pre>

<p>A couple of things to note. The <strong>documents</strong> field contains an array of all the documents that are to be inserted. The <strong>writeConcern</strong> field specifies what would have previously been a <strong>getLastError</strong> command that would follow the pre 2.6 write operations. In other words there is always a response from a write operation in 2.6. This means that <strong>w:0</strong> has different semantics than what one is used to in pre 2.6. In the context <strong>w:0</strong> basically means only return an <strong>ack</strong> without any information about the <strong>success</strong> or <strong>failure</strong> of insert operations.</p>

<p>Now let&rsquo;s quickly look at the update and remove write commands before we take a look at the results that are returned when executing these operations against 2.6.</p>

<h3 id="toc_14">Update Write Command</h3>

<p>There are some slight differences in the update write command in comparison to the insert write command. Let&rsquo;s take a look.</p>

<pre><code>{
    update: 'collection name'
  , updates: [{ 
        q: { a : 1 }
      , u: { $inc : { x : 1}}
      , multi: true/false
      , upsert: true/false
    }, ...]
  , writeConcern: {
    w: 1, j: true, wtimeout: 1000
  }
  , ordered: true/false
}
</code></pre>

<p>We notice that the main difference here is that the updates array is an array of update operations where each entry in the array contains the <strong>q</strong> field that specifies the selector for the update. The <strong>u</strong> contains the update operation. <strong>multi</strong> specifies if we will updateOne or updateAll documents that matches the selection. Finally <strong>upsert</strong> tells the server if it will perform an upsert if the document is not found. Finally let&rsquo;s look at the remove write command.</p>

<h3 id="toc_15">Remove Write Command</h3>

<p>The remove write command is very similar to the update write command. Let&rsquo;s take a look at it.</p>

<pre><code>{
    delete: 'collection name'
  , deletes: [{ 
        q: { a : 1 }
      , limit: 0/1
    }, ...]
  , writeConcern: {
    w: 1, j: true, wtimeout: 1000
  }
  , ordered: true/false
}
</code></pre>

<p>Just an for updates we can see that the entries in the <strong>deletes</strong> array contain documents with specific fields. The <strong>q</strong> field is the selector that will match which documents will be removed. The <strong>limit</strong> field sets the number of elements to be remove. Currently <strong>limit</strong> only supports two values, 0 and 1. The value 0 for <strong>limit</strong> removes all documents that match the selector. A value of 1 for <strong>limit</strong> removes the first matching document only.</p>

<p>So how does the response look when executing the commands against the server.</p>

<h3 id="toc_16">Write Command Results</h3>

<p>One of the best new aspects of the new write commands is that they can return information about each individual operation error in the batch. To avoid not having to transmit more information than necessary only information about errors are returned as well as the aggregated counts of successful operations. Let&rsquo;s look at what a <strong>comprehensive</strong>* result could look like.</p>

<pre><code>{
  &quot;ok&quot; : 1,
  &quot;n&quot; : 0,
  &quot;nModified&quot;: 1, (Applies only to update)
  &quot;nRemoved&quot;: 1, (Applies only to removes)
  &quot;writeErrors&quot; : [
    {
      &quot;index&quot; : 0,
      &quot;code&quot; : 11000,
      &quot;errmsg&quot; : &quot;insertDocument :: caused by :: 11000 E11000 duplicate key error index: t1.t.$a_1  dup key: { : 1.0 }&quot;
    }
  ],
  writeConcernError: {
    code : 22,
    errInfo: { wtimeout : true },
    errmsg: &quot;Could not replicate operation within requested timeout&quot;
  }      
}
</code></pre>

<p>The two most interesting fields here are <strong>writeErrors</strong> and <strong>writeConcernError</strong>. If we take a look at <strong>writeErrors</strong> we can see how it&rsquo;s an array of objects that include an <strong>index</strong> field as well as a <strong>code</strong> and <strong>errmsg</strong>. The <strong>field</strong> references the position of the failing document in the original <strong>documents</strong>, <strong>updates</strong> or <strong>deletes</strong> array allowing the application to identify the original batch document that failed.</p>

<h3 id="toc_17">The Effect of Ordered (true/false)</h3>

<p>The effect of setting <strong>ordered</strong> to true or false have a direct implication on how a write command is processed. Most importantly if <strong>ordered</strong> is set to <strong>true</strong> the write operation will fail on the first write error (meaning the first error that fails to apply the operation to memory). If one sets <strong>ordered</strong> to false however the operation will continue until all operations have been executed (potentially in parallel) and finally return all the results. <strong>writeConcernError</strong> on the other hand does not stop the processing of a bulk operation as the document did not fail to be written to MongoDB, the writeConcern could not be applied.</p>

<p>It helps to think of <strong>writeErrors</strong> as <strong>hard</strong> errors and <strong>writeConcernError</strong> as a soft error.</p>

<h3 id="toc_18">The Special Case of w:0</h3>

<p>The semantics for <strong>w:0</strong> changed for the write commands over the old style pre 2.6 write operations that are a combination of a write wire message and a <strong>getLastError</strong> command afterwards. In the old style <strong>w:0</strong> just meant that the driver would not send a <strong>getLastError</strong> command after the write operation. However all write commands respond and thus the old semantics for <strong>w:0</strong> are not possible to retain. The compromise is to make <strong>w:0</strong> mean I don&rsquo;t care about the results of the command just send me an <strong>Ack</strong>.</p>

<p>So if you execute.</p>

<pre><code>{
    insert: 'collection name'
  , documents: [{ a : 1}, ...]
  , writeConcern: {
    w: 0
  }
  , ordered: true/false
}
</code></pre>

<p>All you receive from the server is the result</p>

<pre><code>{ok : 1}
</code></pre>

<h2 id="toc_19">The Implication For The Bulk API</h2>

<p>There are some implications to the fact that write commands are not mixed operations but either insert/update or removes. The Bulk API lets you mix operations and then merges the results back into a single result that simulates a mixed operations command in MongoDB. What does that mean in practice. Well let&rsquo;s look at how node.js implements <strong>ordered</strong> and <strong>unordered</strong> bulk operations. Let&rsquo;s use examples to show what happens.</p>

<h3 id="toc_20">Ordered Operations</h3>

<p>Let&rsquo;s take the following set off operations performed on a bulk</p>

<pre><code>var ordered = db.collection('documents').initializeOrderedBulkOp();
ordered.insert({ a : 1 });
ordered.find({ a : 1 }).update({ $inc: { x : 1 }});
ordered.insert({ a: 2 });
ordered.find({ a : 2 }).remove();
ordered.insert({ a: 3 });
</code></pre>

<p>When running in ordered mode the bulk API guarantees the ordering of the operations and thus will execute this as 5 operations one after the other.</p>

<pre><code>insert bulk operation
update bulk operation
insert bulk operation
remove bulk operation
insert bulk operation
</code></pre>

<p>We have now reduced the bulk API to performing single operations and your throughput suffers accordingly.</p>

<p>If we re-order our bulk operations in the following way.</p>

<pre><code>var ordered = db.collection('documents').initializeOrderedBulkOp();
ordered.insert({ a : 1 });
ordered.insert({ a: 2 });
ordered.insert({ a: 3 });
ordered.find({ a : 1 }).update({ $inc: { x : 1 }});
ordered.find({ a : 2 }).remove();
</code></pre>

<p>The execution is reduced to the following operations one after the other.</p>

<pre><code>insert bulk operation
update bulk operation
remove bulk operation
</code></pre>

<p>Thus for ordered bulk operations the ordered of operations will impact the number of write commands that need to be executed and thus the throughput possible.</p>

<h3 id="toc_21">Unordered Operations</h3>

<p>Unordered operations have not guarantee about the execution order of operations. Let&rsquo;s take the operations example from above.</p>

<pre><code>var ordered = db.collection('documents').initializeOrderedBulkOp();
ordered.insert({ a : 1 });
ordered.find({ a : 1 }).update({ $inc: { x : 1 }});
ordered.insert({ a: 2 });
ordered.find({ a : 2 }).remove();
ordered.insert({ a: 3 });
</code></pre>

<p>The Node.js driver will collect the operations into separate type specific operations. So we get.</p>

<pre><code>insert bulk operation
update bulk operation
remove bulk operation
</code></pre>

<p>In difference to the <strong>ordered</strong> operation these bulks all get executed in parallel in Node.js and the results then merged when they have all finished.</p>

<h2 id="toc_22">Takeaway</h2>

<p>Due to MongoDb not currently implementing a mixed write operations command it&rsquo;s important to keep this in mind when performing <strong>ordered</strong> bulk operations to avoid the scenario above and take a hit on the write throughput. In the case of <strong>unordered</strong> operations the missing mixed operations command does not impact the throughput.</p>

<p>One thing to note. Although the Bulk API actually supports downconversion to 2.4 the performance impact is considerable as all operations are reduced to single write operations with a <strong>getLastError</strong>. It&rsquo;s recommended to leverage this API primarily with 2.6 or higher.</p>

        </article>
  </div>
</section>



<aside id="meta">

    <div>
        <section id="datecount">
          <h4 id="date"> Wed Apr 16, 2014 </h4>
          <h5 id="wc"> 1800 Words </h5>
        </section>
        <ul id="categories">
          
            <li><a href="http://localhost:1313/topics/development">Development</a> </li>
          
            <li><a href="http://localhost:1313/topics/mongodb">MongoDB</a> </li>
          
            <li><a href="http://localhost:1313/topics/gridfs">GridFS</a> </li>
          
        </ul>
        <ul id="tags">
          
            <li> <a href="http://localhost:1313/tags/mongodb">MongoDB</a> </li>
          
            <li> <a href="http://localhost:1313/tags/drivers">Drivers</a> </li>
          
            <li> <a href="http://localhost:1313/tags/github">github</a> </li>
          
            <li> <a href="http://localhost:1313/tags/mongodb">mongodb</a> </li>
          
            <li> <a href="http://localhost:1313/tags/javascript">Javascript</a> </li>
          
            <li> <a href="http://localhost:1313/tags/js">js</a> </li>
          
        </ul>
    </div>

    <div>
        <section id="prev">
            &nbsp;
        </section><section id="next">
            &nbsp;<a class="next" href="http://localhost:1313/post/an_introduction_to_1_4_and_2_6">Mongo Driver and Mongo DB 2.6 Features <i class="icon-arrow-right"></i></a>
        </section>
    </div>

    <div>
        <section id="author">
             <h4>About the Author:</h4> 
                Christian Kvalheim is a Driver Team Lead and Evangalist for <a href="http://mongodb.com">MongoDB</a>. He is a open
                source contributor and author of the&nbsp;<a
                href="github.com/mongodb/node-mongodb-native"> MongoDB Node.js driver</a>. You can find him on <a href="http://twitter.com/christkv">Twitter</a> and&nbsp;
                <a href="http://github.com/christkv">Github</a>.
        </section>
    </div>

</aside>

<meta itemprop="wordCount" content="1745">
<meta itemprop="datePublished" content="2014-04-16">
<meta itemprop="url" content="http://localhost:1313/post/the_new_bulk_api">


<aside id=comments>
    <div><h2> Comments </h2></div>
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'christiankvalheimcom';
    var disqus_identifier = '1915 http:\/\/christiankvalheim.com\/?p=1916';
    var disqus_title = 'The New Bulk API';
    var disqus_url = 'http:\/\/christiankvalheim.com\/post\/the_new_bulk_api\/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</aside>

<footer>
  <div>
    <p>
    &copy; 2013-14 <span itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Christian Amor Kvalheim.</span></span>
    <a href="http://creativecommons.org/licenses/by/3.0/" title="Creative Commons Attribution">Some rights reserved</a>; 
    please attribute properly and link back. <br>
    Powered by <a href="http://hugo.spf13.com">Hugo</a>.
        Original content created by Steve Francia <a href="http://http://spf13.com/">http://spf13.com/</a>, Derived from <a href="https://github.com/spf13/spf13.com">https://github.com/spf13/spf13.com</a>.
    </p>
  </div>
</footer>
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-15251477-2']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script');
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 
        'http://www') + '.google-analytics.com/ga.js';
    ga.setAttribute('async', 'true');
    document.documentElement.firstChild.appendChild(ga);
  })();

(function(){var j=function(a,b){return window.getComputedStyle?getComputedStyle(a).getPropertyValue(b):a.currentStyle[b]};var k=function(a,b,c){if(a.addEventListener)a.addEventListener(b,c,false);else a.attachEvent('on'+b,c)};var l=function(a,b){for(key in b)if(b.hasOwnProperty(key))a[key]=b[key];return a};window.fitText=function(d,e,f){var g=l({'minFontSize':-1/0,'maxFontSize':1/0},f);var h=function(a){var b=e||1;var c=function(){a.style.fontSize=Math.max(Math.min(a.clientWidth/(b*10),parseFloat(g.maxFontSize)),parseFloat(g.minFontSize))+'px'};c();k(window,'resize',c)};if(d.length)for(var i=0;i<d.length;i++)h(d[i]);else h(d);return d}})();
fitText(document.getElementById('title'), 1)

</script>
</body>
</html>

